{% extends "base.html" %}


{% block content %}
{% load static %}
<div class="min-h-screen flex flex-col bg-atb-g-50 text-left py-24 px-4 md:px-12 lg:px-32 font-primary">

    <div class="flex flex-col gap-2">
        <h2 class="text-[30px]  font-[600] text-atb-g-900 font-primary">Requests</h2>
        <p class="text-[16px] text-atb-g-600">View and manage both borrow and return requests.</p>
    </div>

    <hr class="border-atb-g-200 mt-6">
    
    

    <div class="w-full flex flex-col items-start  md:flex-row p-4 md:p-6 gap-6 md:gap-8">

        <!-- Tabs -->

        <div class="flex flex-col gap-4 p-4 sm:p-6 md:p-8 lg:p-12 bg-white border border-white rounded-[12px] w-full md:w-1/3">
            <button id="borrow-tab"
                class="tab-button px-12 py-2 text-[18px] font-semibold rounded-[8px] transition-colors duration-200 border-[1px] border-atb-g-300 bg-white text-atb-g-700 shadow-[0px_1px_2px_0px_#1018280D]
           hover:bg-atb-g-50 hover:text-atb-g-800 
           focus:bg-white focus:text-atb-g-700 focus:shadow-[0_0_0_4px_#F2F4F7]
           disabled:bg-atb-g-50 disabled:text-atb-g-300 disabled:border-atb-g-200 disabled:opacity-70"
                onclick="showTab('borrow')" disabled>
                Borrows
            </button>
            <button id="return-tab"
                class="tab-button px-12 py-2 text-[18px] font-semibold rounded-[8px] transition-colors duration-200 border-[1px] border-atb-g-300 bg-white text-atb-g-700 shadow-[0px_1px_2px_0px_#1018280D]
           hover:bg-atb-g-50 hover:text-atb-g-800 
           focus:bg-white focus:text-atb-g-700 focus:shadow-[0_0_0_4px_#F2F4F7]
           disabled:bg-atb-g-50 disabled:text-atb-g-300 disabled:border-atb-g-200 disabled:opacity-70"
                onclick="showTab('return')" >
                Returns
            </button>

            {% include 'sort-filter/sort.html' %}


            <div id="borrow-filter" class="flex flex-col gap-2">
                {% include 'sort-filter/borrow_filter.html' %}
            </div>

            <div id="return-filter" class="flex flex-col gap-2 hidden">
                {% include 'sort-filter/return_filter.html' %}
            </div>

        </div>

        <!-- Borrow Request List -->

        <div id="borrow-section" class="tab-section w-full md:w-2/3 border border-white bg-white rounded-[12px] p-4 sm:p-6 md:p-12">
            {% if borrows %}
                <div class="space-y-4">
                    {% for instance in borrows %}
                        <a href="{% url 'requests:borrow-detail' instance.id %}" 
                            class="block bg-atb-g-50 rounded-[12px] p-8 hover:bg-atb-g-200
                            focus:border-none focus:ring-0 focus:shadow-[0_0_0_4px_#F2F4F7]
                            transition duration-300 flex flex-row items-center gap-8 request-card border"
                            data-review='{{ instance.review }}' 
                            data-request-type='borrow'>
                            <div class="flex justify-start mt-2 border">
                                {% if instance.review == 'approved' %}
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-16 text-atb-s-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                            {% elif instance.review == 'pending' %}

                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-16 text-atb-w-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                            {% else %}

                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-16 text-atb-e-500">
                              <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>

                            {% endif %}
                            </div>
                            <div class="text-left border grow">
                            <h3 class="text-xl font-semibold text-[#334155]">{{ instance }}</h3>
                            <p class="text-[#475569]">Requested at {{ instance.date_requested }} &bull; Returning on {{ instance.return_date }}</p>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-center text-atb-g-500">No borrow requests available.</p>
            {% endif %}
        </div>

        <!-- Return Request List -->

        <div id="return-section" class="tab-section w-full md:w-2/3 border border-white bg-white rounded-[12px] p-4 sm:p-6 md:p-12 hidden">
            {% if returns %}
                <div class="space-y-4">
                    {% for instance in returns %}
                        <a href="{% url 'requests:return-detail' instance.id %}" 
                            class="block bg-atb-g-50 rounded-[12px] p-8
                            hover:bg-atb-g-200 focus:border-none focus:ring-0
                            focus:shadow-[0_0_0_4px_#F2F4F7] transition
                            duration-300 flex flex-row items-center gap-8 request-card"
                            data-review="{{ instance.review }}"
                            data-request-type="return">
                            <div class="flex justify-start mt-2">
                                {% if instance.approved %}
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-16 text-atb-s-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                            {% else %}

                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-16 text-atb-w-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                            {% endif %}
                            </div>
                            <div>
                            <h3 class="text-xl font-semibold text-[#334155]">{{ instance }}</h3>
                            <p class="text-[#475569]">Condition : {{ instance.condition }} &bull; Feedback : {{ instance.feedback|slice:":20" }}</p>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-center text-atb-g-500">No return requests available.</p>
            {% endif %}
        </div>

    </div>
</div>

{{ breviews|json_script:"b-request-review" }}
{{ rreviews|json_script:"r-request-review" }}
<script>
let currentTab = 'borrow';
const bRequestReview = JSON.parse(document.getElementById('b-request-review').textContent);
const rRequestReview = JSON.parse(document.getElementById('r-request-review').textContent);

const activeBRRFilters = new Set();
const activeRRRFilters = new Set();

document.addEventListener('DOMContentLoaded', function () {
    showTab('borrow');
});


function toggleReviewFilter(review, prefix) {
    const isBorrow = prefix === 'borrow';
    const activeSet = isBorrow ? activeBRRFilters : activeRRRFilters;
    const btnId = `${prefix}-${review}-review-tab`;
    const btn = document.getElementById(btnId);

    if (!btn) return;

    if (activeSet.has(review)) {
        activeSet.delete(review);
    } else {
        activeSet.add(review);
    }

    updateReviewButtons(prefix, isBorrow ? bRequestReview : rRequestReview, activeSet);
    applyFilters();
}

function updateReviewButtons(prefix, reviews, activeSet) {
    reviews.forEach(review => {
        const btn = document.getElementById(`${prefix}-${review}-review-tab`);
        if (!btn) return;

        if (activeSet.has(review)) {
            btn.classList.remove('opacity-50','text-atb-g-700','bg-white','hover:bg-atb-g-50','hover:text-atb-g-800');
            btn.classList.add('text-white','bg-atb-p-500','hover:bg-atb-p-700','hover:text-white');
        } else {
            btn.classList.add('opacity-50','text-atb-g-700','bg-white','hover:bg-atb-g-50','hover:text-atb-g-800');
            btn.classList.remove('text-white','bg-atb-p-500','hover:bg-atb-p-700','hover:text-white');
        }
    });
}

function applyFilters() {
    const cards = document.querySelectorAll('.request-card');

    cards.forEach(card => {
        const review = card.getAttribute('data-review');
        const requestType = card.getAttribute('data-request-type');
        let reviewMatch = true;

        if (requestType === 'borrow') {
            reviewMatch = activeBRRFilters.size === 0 || activeBRRFilters.has(review);
        } else if (requestType === 'return') {
            reviewMatch = activeRRRFilters.size === 0 || activeRRRFilters.has(review);
        }

        card.style.display = reviewMatch ? 'block' : 'none';
    });
}


function showTab(tab) {
    const borrowTab = document.getElementById('borrow-tab');
    const returnTab = document.getElementById('return-tab');
    const borrowSection = document.getElementById('borrow-section');
    const returnSection = document.getElementById('return-section');
    const borrowFilter = document.getElementById('borrow-filter');
    const returnFilter = document.getElementById('return-filter');


    if (tab === 'borrow') {
        // Show borrow section, hide return
        borrowSection.classList.remove('hidden');
        returnSection.classList.add('hidden');
        borrowFilter.classList.remove('hidden');
        returnFilter.classList.add('hidden');

        // Enable borrow, disable return
        borrowTab.disabled = true;
        returnTab.disabled = false;
    } else {
        // Show return section, hide borrow
        borrowSection.classList.add('hidden');
        returnSection.classList.remove('hidden');
        borrowFilter.classList.add('hidden');
        returnFilter.classList.remove('hidden');

        // Enable return, disable borrow
        borrowTab.disabled = false;
        returnTab.disabled = true;
    }
}

</script>

{% endblock content %}

